<canvas width="600px" height="598px" id="image"></canvas>
<script type="application/javascript">
var canvasImage = document.getElementById('image'),
ctxImage = canvasImage.getContext('2d');

make_base();

function make_base()
{
  base_image = new Image();
  base_image.src = 'warp.png';
  base_image.onload = function(){
    ctxImage.drawImage(base_image, 0, 0);
  }
}
</script>


<canvas width="600px" height="598px" id="canvas"></canvas>

<script type="application/javascript">
var poly1=[ 5,5, 100,50, 50,100, 10,90 ];
var canvas=document.getElementById("canvas")
var ctx = canvas.getContext('2d');
//drawPoly(poly1, '#f00');
    var polyArray = [];
    var totalDraws = 0;
    polyArray.push({
        points: poly1,
        colour: '#f00'
    });
    
    
    for (var i = 0; i < randomIntFromInterval(10,20); i++) {
        addPoly();
    }
    
    function distanceFromImage() {
        // Get the CanvasPixelArray from the given coordinates and dimensions.
        
        // get from source
        var imgdImage = ctxImage.getImageData(0, 0, canvas.width, canvas.height);
        var pixImage = imgdImage.data;
        
        // get from canvas
        var imgd = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var pix = imgd.data;
        
        var distanceTotal = 0;

        // Loop over each pixel and invert the color.
        for (var i = 0, n = pix.length; i < n; i += 4) {
            //pix[i  ] =  // red
            //pix[i+1] =  // green
            //pix[i+2] =  // blue
            // i+3 is alpha (the fourth element)
            
            distanceTotal += Math.abs(pixImage[i] - pix[i]);
            distanceTotal += Math.abs(pixImage[i+1] - pix[i+1]);
            distanceTotal += Math.abs(pixImage[i+2] - pix[i+2]);
        }
        
        return distanceTotal;

        // Draw the ImageData at the given (x,y) coordinates.
        //ctx.putImageData(imgd, 0, 0);
    }
    
    init();
    function init() {
        drawLoop();
        setInterval(modify, 100);
    }
    
    function drawLoop() {
        canvas.width = canvas.width;
        for (i = 0; i < polyArray.length; i++) {
            drawPoly(polyArray[i].points, polyArray[i].colour);
        }
        //console.log("Polygon count: " + polyArray.length);
    }
    
    function modify() {
        var beforeDistance = distanceFromImage();
        
        var tempObject = JSON.parse(JSON.stringify(polyArray));
        
        var changeMode = randomIntFromInterval(0, 100);
        if (changeMode < 50){
            modifyPoly();
        }
        else if (changeMode < 85) {
            addPoly();
        }
        else {
            removePoly();
        }        
        drawLoop();
        
        var afterDistance = distanceFromImage();
        
        // console.log(beforeDistance + "    " + afterDistance + "     " + (beforeDistance > afterDistance));
        
        
        if (beforeDistance < afterDistance) {
            polyArray = JSON.parse(JSON.stringify(tempObject));
        }
    }
    
    function addPoly() {
        if (polyArray.length > 50) return;
        
        var pointCount = randomIntFromInterval(4, 5);
        var points = [];
        for (var j = 0; j < pointCount; j++) {
            points.push(randomIntFromInterval(0, canvas.width));
            points.push(randomIntFromInterval(0, canvas.height));
        }
        polyArray.push({
            points: points,
            colour: getRandomColor()
        });
    }
    
    function removePoly() {
        if (polyArray.length < 10) return;
        
        var removeIndex = randomIntFromInterval(0, polyArray.length - 1)
        polyArray.splice(removeIndex, 1);
    }
    
    function modifyPoly() {
        var polyIndex = randomIntFromInterval(0, polyArray.length - 1);
        var pointIndex = randomIntFromInterval(0, polyArray[polyIndex].points.length - 1);
        polyArray[polyIndex].points[pointIndex] += randomIntFromInterval(-10,10);
    }
    
    function drawPoly(poly, colour) {
        
        totalDraws++;

        ctx.fillStyle = colour;

        ctx.beginPath();
        ctx.moveTo(poly[0], poly[1]);
        for( item=2 ; item < poly.length-1 ; item+=2 ){
            ctx.lineTo( poly[item] , poly[item+1] )
        }

        ctx.closePath();
        ctx.fill();
        
        if (totalDraws % 1000 === 0) {
            save();
        }
    }
    
    function save() {
        var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");  // here is the most important part because if you dont replace you will get a DOM 18 exception.
        
        window.location.href=image;
    }
    
    // from http://stackoverflow.com/questions/1484506/random-color-generator-in-javascript
    function getRandomColor() {
        var letters = '0123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    
    // from http://stackoverflow.com/questions/4959975/generate-random-value-between-two-numbers-in-javascript
    function randomIntFromInterval(min,max)
    {
        return Math.floor(Math.random()*(max-min+1)+min);
    }
</script>